// ========== POWER SWITCH SYSTEM V3 ==========
// Developer: mh_alliwa (Telegram: @mh_alliwa, Instagram: @mh.alliwa)
// Sistem Dual Source dengan 3 Web Interface
// Versi: 3.0 - Advanced Real-time Monitoring & Control

// ========== CONFIGURASI ==========
#define BLYNK_TEMPLATE_ID "TMPL6mhCLY2HX"
#define BLYNK_TEMPLATE_NAME "Power Switch V3"
#define BLYNK_AUTH_TOKEN "9V0U-QtNPYRO63Q-oR26CalZ1CB7fErt"

// ========== LIBRARY ==========
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <BlynkSimpleEsp32.h>
#include <Preferences.h>
#include <ArduinoJson.h>
#include <WebServer.h>
#include <ESPmDNS.h>
#include <Update.h>  // Untuk OTA updates
#include <NTPClient.h>
#include <WiFiUdp.h>

// ========== PIN DEFINITIONS ==========
#define PIN_ZMPT1 34
#define PIN_ZMPT2 35
#define PIN_ACS 32
#define RELAY1_PIN 25
#define RELAY2_PIN 26
#define BUZZER_PIN 27
#define LED_STATUS 2
#define BUTTON_MANUAL 33

// ========== WIFI & TELEGRAM ==========
char ssid[] = "KingFinix";
char pass[] = "";
#define BOT_TOKEN "8598852476:AAFsvYnX94UvAN6uSqgr1rFWP217YBGJMHg"
#define CHAT_ID "6293340373"

// ========== WEB SERVER ==========
#define WEB_PORT 80
WebServer server(WEB_PORT);

// ========== NTP CLIENT ==========
WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP, "id.pool.ntp.org", 25200, 60000);

// ========== GITHUB PAGES CONFIG ==========
const char* githubUsername = "mh-alliwa"; // Ganti dengan username GitHub Anda
const char* githubRepo = "power-switch-dashboard"; // Ganti dengan nama repo

// ========== SENSOR CONFIG ==========
typedef struct {
  float voltage1;
  float voltage2;
  float current;
  float power;
  float energy;
  float frequency1;
  float frequency2;
  float powerFactor;
  uint32_t timestamp;
} SensorData;

typedef struct {
  int zeroV1;
  int zeroV2;
  int zeroI;
  float calibrationFactorV1;
  float calibrationFactorV2;
  float calibrationFactorI;
  float voltageOffsetV1;
  float voltageOffsetV2;
} OptimizationData;

// ========== SYSTEM OBJECTS ==========
LiquidCrystal_I2C lcd(0x27, 16, 2);
WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);
BlynkTimer timer;
Preferences preferences;

// ========== GLOBAL VARIABLES ==========
SensorData sensors = {0};
OptimizationData optim = {2048, 2048, 2048, 1.0, 1.0, 1.0, 0.0, 0.0};

enum SystemState {
  STATE_OFF,
  STATE_SOURCE1_ACTIVE,
  STATE_SOURCE2_ACTIVE,
  STATE_SWITCHING,
  STATE_FAULT,
  STATE_OPTIMIZATION,
  STATE_UPDATE
};

SystemState systemState = STATE_OFF;
bool autoMode = true;
bool maintenanceMode = false;
bool notificationEnabled = true;
bool dataLogging = true;
bool cloudSync = false;

// Energy Management
float totalEnergy = 0;
float dailyEnergy = 0;
float monthlyEnergy = 0;
uint32_t lastEnergyUpdate = 0;
uint32_t lastDailyReset = 0;
uint32_t lastMonthlyReset = 0;

// Statistics
struct {
  uint32_t totalUptime;
  uint32_t source1Uptime;
  uint32_t source2Uptime;
  uint32_t switchCount;
  uint32_t faultCount;
  uint32_t lastSwitchTime;
} stats = {0};

// Real-time data buffers
#define DATA_BUFFER_SIZE 100
float voltageHistory1[DATA_BUFFER_SIZE];
float voltageHistory2[DATA_BUFFER_SIZE];
float currentHistory[DATA_BUFFER_SIZE];
int historyIndex = 0;

// ========== HTML PAGES ==========

// 1. BASIC WEB INTERFACE (Internal ESP32)
const char* basicWebPage = R"rawliteral(
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Switch V3 - Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 2.5rem; margin-bottom: 10px; }
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
        .status-online { background: #2ecc71; }
        .status-offline { background: #e74c3c; }
        .status-warning { background: #f39c12; }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h3 { margin-bottom: 20px; color: #3498db; }
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .chart-container {
            height: 300px;
            margin-top: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">‚ö° POWER SWITCH V3</div>
            <p>Advanced Dual Source Power Management System</p>
            <div class="status-badge" id="system-status">Loading...</div>
            <p>Developer: mh_alliwa | Telegram: @mh_alliwa | Instagram: @mh.alliwa</p>
        </header>
        
        <div class="dashboard">
            <!-- Voltage Card -->
            <div class="card">
                <h3>‚ö° Voltage Monitoring</h3>
                <div class="sensor-value" id="voltage1">0.0 V</div>
                <div style="text-align: center;">Source 1</div>
                <div class="sensor-value" id="voltage2">0.0 V</div>
                <div style="text-align: center;">Source 2</div>
                <div id="voltage-quality">Quality: Checking...</div>
            </div>
            
            <!-- Current & Power Card -->
            <div class="card">
                <h3>üîã Power Analytics</h3>
                <div class="sensor-value" id="current">0.000 A</div>
                <div style="text-align: center;">Current</div>
                <div class="sensor-value" id="power">0.0 W</div>
                <div style="text-align: center;">Power</div>
                <div class="sensor-value" id="energy">0.000 kWh</div>
                <div style="text-align: center;">Total Energy</div>
            </div>
            
            <!-- System Status Card -->
            <div class="card">
                <h3>‚öôÔ∏è System Control</h3>
                <div style="margin: 15px 0;">
                    <div>Mode: <span id="mode-status">AUTO</span></div>
                    <div>Maintenance: <span id="maintenance-status">OFF</span></div>
                    <div>Uptime: <span id="uptime">0s</span></div>
                </div>
                <div class="controls">
                    <button class="btn btn-success" onclick="controlSource(1)">Source 1</button>
                    <button class="btn btn-success" onclick="controlSource(2)">Source 2</button>
                    <button class="btn btn-danger" onclick="controlSource(0)">OFF</button>
                    <button class="btn btn-warning" onclick="toggleMode()">Toggle Mode</button>
                </div>
            </div>
        </div>
        
        <!-- Real-time Charts -->
        <div class="card">
            <h3>üìä Real-time Monitoring</h3>
            <div class="chart-container">
                <canvas id="voltageChart"></canvas>
            </div>
            <div class="controls" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="window.open('/advanced', '_blank')">Advanced Dashboard</button>
                <button class="btn btn-primary" onclick="window.open('https://%GITHUB_USERNAME%.github.io/%GITHUB_REPO%', '_blank')">GitHub Dashboard</button>
                <button class="btn" onclick="downloadLogs()" style="background: #9b59b6; color: white;">Download Logs</button>
            </div>
        </div>
        
        <div class="footer">
            <p>Power Switch System V3 | Web Interface v3.0</p>
            <p>¬© 2024 Developed by mh_alliwa | Real-time Monitoring System</p>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let voltageChart;
        let chartData = {
            labels: [],
            datasets: [
                { label: 'Source 1 (V)', data: [], borderColor: '#3498db', fill: false },
                { label: 'Source 2 (V)', data: [], borderColor: '#2ecc71', fill: false }
            ]
        };
        
        function initChart() {
            const ctx = document.getElementById('voltageChart').getContext('2d');
            voltageChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Voltage (V)' } },
                        x: { title: { display: true, text: 'Time' } }
                    }
                }
            });
        }
        
        async function fetchData() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update values
                document.getElementById('voltage1').textContent = data.voltage1.toFixed(1) + ' V';
                document.getElementById('voltage2').textContent = data.voltage2.toFixed(1) + ' V';
                document.getElementById('current').textContent = data.current.toFixed(3) + ' A';
                document.getElementById('power').textContent = data.power.toFixed(1) + ' W';
                document.getElementById('energy').textContent = data.totalEnergy.toFixed(3) + ' kWh';
                document.getElementById('system-status').textContent = data.systemState;
                document.getElementById('system-status').className = 'status-badge ' + 
                    (data.systemState.includes('ACTIVE') ? 'status-online' : 
                     data.systemState.includes('OFF') ? 'status-offline' : 'status-warning');
                document.getElementById('mode-status').textContent = data.autoMode ? 'AUTO' : 'MANUAL';
                document.getElementById('maintenance-status').textContent = data.maintenanceMode ? 'ON' : 'OFF';
                document.getElementById('uptime').textContent = data.uptime + 's';
                
                // Update chart
                const time = new Date().toLocaleTimeString();
                chartData.labels.push(time);
                chartData.datasets[0].data.push(data.voltage1);
                chartData.datasets[1].data.push(data.voltage2);
                
                if (chartData.labels.length > 20) {
                    chartData.labels.shift();
                    chartData.datasets[0].data.shift();
                    chartData.datasets[1].data.shift();
                }
                
                voltageChart.update('none');
                
                // Update voltage quality
                const voltageQuality = document.getElementById('voltage-quality');
                if (data.voltage1 > 210 && data.voltage1 < 230 && 
                    data.voltage2 > 210 && data.voltage2 < 230) {
                    voltageQuality.textContent = 'Quality: EXCELLENT';
                    voltageQuality.style.color = '#2ecc71';
                } else if (data.voltage1 < 180 || data.voltage2 < 180) {
                    voltageQuality.textContent = 'Quality: LOW VOLTAGE';
                    voltageQuality.style.color = '#e74c3c';
                } else {
                    voltageQuality.textContent = 'Quality: STABLE';
                    voltageQuality.style.color = '#f39c12';
                }
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        async function controlSource(source) {
            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: source === 0 ? 'off' : 
                               source === 1 ? 'source1' : 'source2'
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    fetchData();
                }
            } catch (error) {
                alert('Control failed');
            }
        }
        
        async function toggleMode() {
            try {
                const response = await fetch('/api/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'toggle' })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Mode changed to ' + (result.autoMode ? 'AUTO' : 'MANUAL'));
                    fetchData();
                }
            } catch (error) {
                alert('Mode change failed');
            }
        }
        
        async function downloadLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `power_system_logs_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Failed to download logs');
            }
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            initChart();
            fetchData();
            setInterval(fetchData, 1000);
            
            // Replace GitHub links
            document.body.innerHTML = document.body.innerHTML
                .replace(/%GITHUB_USERNAME%/g, '%s')
                .replace(/%GITHUB_REPO%/g, '%s');
        });
    </script>
</body>
</html>
)rawliteral";

// 2. ADVANCED WEB INTERFACE (Internal ESP32)
const char* advancedWebPage = R"rawliteral(
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Switch V3 - Advanced Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #1a1a2e;
            --light: #f8f9fa;
        }
        body {
            background: linear-gradient(135deg, var(--dark), #16213e);
            color: var(--light);
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--success) !important;
        }
        .sidebar {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            padding-top: 80px;
        }
        .sidebar .nav-link {
            color: var(--light);
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: var(--primary);
            color: white;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
        }
        .btn-custom {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.4);
        }
        .modal-content {
            background: var(--dark);
            color: var(--light);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .table {
            color: var(--light);
        }
        .table-hover tbody tr:hover {
            background: rgba(255,255,255,0.1);
        }
        .gauge {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        @media (max-width: 768px) {
            .sidebar {
                position: static;
                height: auto;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-bolt me-2"></i>POWER SWITCH V3
            </a>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-3" id="connection-status">Connected</span>
                <span class="text-light me-3" id="current-time">00:00:00</span>
                <button class="btn btn-outline-light btn-sm" onclick="toggleFullscreen()">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar d-none d-lg-block" style="width: 250px;">
        <div class="nav flex-column">
            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
            <a class="nav-link" href="#" onclick="showSection('monitoring')">
                <i class="fas fa-chart-line me-2"></i>Real-time Monitoring
            </a>
            <a class="nav-link" href="#" onclick="showSection('control')">
                <i class="fas fa-gamepad me-2"></i>Control Panel
            </a>
            <a class="nav-link" href="#" onclick="showSection('optimization')">
                <i class="fas fa-cogs me-2"></i>System Optimization
            </a>
            <a class="nav-link" href="#" onclick="showSection('analytics')">
                <i class="fas fa-chart-bar me-2"></i>Analytics
            </a>
            <a class="nav-link" href="#" onclick="showSection('settings')">
                <i class="fas fa-cog me-2"></i>Settings
            </a>
            <a class="nav-link" href="#" onclick="showSection('logs')">
                <i class="fas fa-clipboard-list me-2"></i>System Logs
            </a>
            <a class="nav-link" href="#" onclick="showSection('about')">
                <i class="fas fa-info-circle me-2"></i>About
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-section">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card text-center">
                        <i class="fas fa-bolt fa-3x text-warning mb-3"></i>
                        <div class="stat-value" id="total-power">0.0 W</div>
                        <div class="stat-label">Current Power</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card text-center">
                        <i class="fas fa-battery-full fa-3x text-success mb-3"></i>
                        <div class="stat-value" id="total-energy">0.000 kWh</div>
                        <div class="stat-label">Total Energy</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card text-center">
                        <i class="fas fa-clock fa-3x text-info mb-3"></i>
                        <div class="stat-value" id="system-uptime">0d 0h 0m</div>
                        <div class="stat-label">System Uptime</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card text-center">
                        <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                        <div class="stat-value" id="system-status">IDLE</div>
                        <div class="stat-label">System Status</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="chart-container">
                        <canvas id="gaugeChart"></canvas>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="stat-card text-center">
                                <div class="stat-value" id="voltage1">0.0 V</div>
                                <div class="stat-label">Source 1 Voltage</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card text-center">
                                <div class="stat-value" id="voltage2">0.0 V</div>
                                <div class="stat-label">Source 2 Voltage</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div id="monitoring-section" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <canvas id="monitoringChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="currentChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="powerChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel Section -->
        <div id="control-section" style="display: none;">
            <div class="row">
                <div class="col-md-8">
                    <div class="card bg-dark border-0 p-4">
                        <h4 class="mb-4"><i class="fas fa-sliders-h me-2"></i>Manual Control</h4>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-success w-100 py-3" onclick="controlSource(1)">
                                    <i class="fas fa-power-off fa-2x"></i><br>
                                    Source 1 ON
                                </button>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-success w-100 py-3" onclick="controlSource(2)">
                                    <i class="fas fa-power-off fa-2x"></i><br>
                                    Source 2 ON
                                </button>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-danger w-100 py-3" onclick="controlSource(0)">
                                    <i class="fas fa-stop-circle fa-2x"></i><br>
                                    Emergency OFF
                                </button>
                            </div>
                        </div>
                        
                        <h4 class="mt-4 mb-3"><i class="fas fa-cogs me-2"></i>System Configuration</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Operation Mode</label>
                                    <select class="form-control bg-dark text-light" id="operation-mode">
                                        <option value="auto">Auto Mode</option>
                                        <option value="manual">Manual Mode</option>
                                        <option value="eco">Eco Mode</option>
                                        <option value="priority">Priority Mode</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Switch Threshold (V)</label>
                                    <input type="number" class="form-control bg-dark text-light" 
                                           id="switch-threshold" value="180" min="170" max="250">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <button class="btn btn-primary w-100" onclick="saveConfiguration()">
                                    <i class="fas fa-save me-2"></i>Save Configuration
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark border-0 p-4 h-100">
                        <h4 class="mb-4"><i class="fas fa-info-circle me-2"></i>System Info</h4>
                        <div class="system-info">
                            <div class="mb-2">
                                <span class="text-muted">Current Source:</span>
                                <span class="float-end" id="current-source">None</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">Auto Mode:</span>
                                <span class="float-end" id="auto-mode-status">Enabled</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">Maintenance Mode:</span>
                                <span class="float-end" id="maintenance-mode-status">Disabled</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">Last Switch:</span>
                                <span class="float-end" id="last-switch">Never</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">Total Switches:</span>
                                <span class="float-end" id="total-switches">0</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">System Temperature:</span>
                                <span class="float-end" id="system-temp">-- ¬∞C</span>
                            </div>
                            <div class="mb-2">
                                <span class="text-muted">WiFi Signal:</span>
                                <span class="float-end" id="wifi-signal">-- dBm</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimization Section -->
        <div id="optimization-section" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-dark border-0 p-4">
                        <h4 class="mb-4"><i class="fas fa-tachometer-alt me-2"></i>System Optimization</h4>
                        
                        <div class="mb-3">
                            <label class="form-label">Voltage Calibration</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Source 1</span>
                                <input type="number" class="form-control bg-dark text-light" 
                                       id="cal-v1" value="1.0" step="0.001">
                                <button class="btn btn-outline-info" onclick="calibrateSource(1)">
                                    Calibrate
                                </button>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Source 2</span>
                                <input type="number" class="form-control bg-dark text-light" 
                                       id="cal-v2" value="1.0" step="0.001">
                                <button class="btn btn-outline-info" onclick="calibrateSource(2)">
                                    Calibrate
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Current Sensor Calibration</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-dark text-light" 
                                       id="cal-current" value="1.0" step="0.001">
                                <button class="btn btn-outline-info" onclick="calibrateCurrent()">
                                    Calibrate
                                </button>
                            </div>
                        </div>
                        
                        <button class="btn btn-warning w-100 mb-3" onclick="autoOptimization()">
                            <i class="fas fa-magic me-2"></i>Auto Optimization
                        </button>
                        
                        <button class="btn btn-danger w-100" onclick="resetCalibration()">
                            <i class="fas fa-redo me-2"></i>Reset to Default
                        </button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card bg-dark border-0 p-4">
                        <h4 class="mb-4"><i class="fas fa-chart-pie me-2"></i>Optimization Results</h4>
                        <div id="optimization-results">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Run optimization to see results
                            </div>
                        </div>
                        <div class="mt-3">
                            <h5><i class="fas fa-history me-2"></i>Optimization History</h5>
                            <div class="table-responsive">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="optimization-history">
                                        <tr><td colspan="3" class="text-center">No history available</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics-section" style="display: none;">
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <canvas id="energyChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-dark border-0 p-4">
                        <h4 class="mb-4"><i class="fas fa-wifi me-2"></i>Network Settings</h4>
                        
                        <div class="mb-3">
                            <label class="form-label">WiFi SSID</label>
                            <input type="text" class="form-control bg-dark text-light" 
                                   id="wifi-ssid" value="%SSID%">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">WiFi Password</label>
                            <input type="password" class="form-control bg-dark text-light" 
                                   id="wifi-password" value="%PASSWORD%">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Hostname</label>
                            <input type="text" class="form-control bg-dark text-light" 
                                   id="hostname" value="powerswitch-v3">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Web Server Port</label>
                            <input type="number" class="form-control bg-dark text-light" 
                                   id="web-port" value="80" min="80" max="65535">
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="saveNetworkSettings()">
                            <i class="fas fa-save me-2"></i>Save Network Settings
                        </button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card bg-dark border-0 p-4">
                        <h4 class="mb-4"><i class="fas fa-bell me-2"></i>Notification Settings</h4>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notif-telegram" checked>
                            <label class="form-check-label" for="notif-telegram">Telegram Notifications</label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notif-email">
                            <label class="form-check-label" for="notif-email">Email Notifications</label>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="notif-sms">
                            <label class="form-check-label" for="notif-sms">SMS Notifications</label>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Alert Thresholds</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Voltage Low</span>
                                <input type="number" class="form-control bg-dark text-light" 
                                       id="alert-vlow" value="170" min="0" max="300">
                                <span class="input-group-text">V</span>
                            </div>
                            <div class="input-group mb-2">
                                <span class="input-group-text">Voltage High</span>
                                <input type="number" class="form-control bg-dark text-light" 
                                       id="alert-vhigh" value="250" min="0" max="300">
                                <span class="input-group-text">V</span>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text">Current High</span>
                                <input type="number" class="form-control bg-dark text-light" 
                                       id="alert-ihigh" value="20" min="0" max="30">
                                <span class="input-group-text">A</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="saveNotificationSettings()">
                            <i class="fas fa-save me-2"></i>Save Notification Settings
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card bg-dark border-0 p-4">
                        <h4 class="mb-4"><i class="fas fa-shield-alt me-2"></i>System Maintenance</h4>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-info w-100" onclick="backupSystem()">
                                    <i class="fas fa-download me-2"></i>Backup System
                                </button>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-warning w-100" onclick="restartSystem()">
                                    <i class="fas fa-redo me-2"></i>Restart System
                                </button>
                            </div>
                            <div class="col-md-4 mb-3">
                                <button class="btn btn-danger w-100" onclick="factoryReset()">
                                    <i class="fas fa-trash me-2"></i>Factory Reset
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h5><i class="fas fa-microchip me-2"></i>System Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="system-info">
                                        <div class="mb-2">
                                            <span class="text-muted">ESP32 Chip ID:</span>
                                            <span class="float-end" id="chip-id">--</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted">Flash Size:</span>
                                            <span class="float-end" id="flash-size">-- MB</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted">Free Heap:</span>
                                            <span class="float-end" id="free-heap">-- KB</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="system-info">
                                        <div class="mb-2">
                                            <span class="text-muted">Firmware Version:</span>
                                            <span class="float-end">V3.0</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted">Last Updated:</span>
                                            <span class="float-end" id="last-update">--</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted">Developer:</span>
                                            <span class="float-end">mh_alliwa</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logs-section" style="display: none;">
            <div class="card bg-dark border-0 p-4">
                <h4 class="mb-4"><i class="fas fa-clipboard-list me-2"></i>System Logs</h4>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select bg-dark text-light" id="log-level">
                            <option value="all">All Logs</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select bg-dark text-light" id="log-period">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control bg-dark text-light" 
                                   placeholder="Search logs..." id="log-search">
                            <button class="btn btn-primary" onclick="searchLogs()">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-success" onclick="exportLogs()">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-danger" onclick="clearLogs()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-dark">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Source</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="log-table">
                            <tr><td colspan="4" class="text-center">Loading logs...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-secondary" onclick="loadMoreLogs('prev')">
                        <i class="fas fa-chevron-left me-2"></i>Previous
                    </button>
                    <span id="log-page-info">Page 1 of 1</span>
                    <button class="btn btn-secondary" onclick="loadMoreLogs('next')">
                        Next<i class="fas fa-chevron-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- About Section -->
        <div id="about-section" style="display: none;">
            <div class="card bg-dark border-0 p-4">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="mb-4">
                            <i class="fas fa-bolt fa-5x text-warning mb-3"></i>
                            <h2>POWER SWITCH V3</h2>
                            <p class="text-muted">Advanced Power Management System</p>
                        </div>
                        
                        <div class="d-flex justify-content-center gap-3 mb-4">
                            <a href="https://t.me/mh_alliwa" class="btn btn-primary" target="_blank">
                                <i class="fab fa-telegram me-2"></i>Telegram
                            </a>
                            <a href="https://instagram.com/mh.alliwa" class="btn btn-danger" target="_blank">
                                <i class="fab fa-instagram me-2"></i>Instagram
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <h4 class="mb-3">System Information</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="system-info">
                                    <div class="mb-2">
                                        <span class="text-muted">Version:</span>
                                        <span class="float-end">3.0.0</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">Release Date:</span>
                                        <span class="float-end">2024</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">License:</span>
                                        <span class="float-end">MIT</span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">Developer:</span>
                                        <span class="float-end">mh_alliwa</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="system-info">
                                    <div class="mb-2">
                                        <span class="text-muted">GitHub:</span>
                                        <span class="float-end">
                                            <a href="https://github.com/mh-alliwa" class="text-info" target="_blank">
                                                mh-alliwa
                                            </a>
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">Support:</span>
                                        <span class="float-end">
                                            <a href="mailto:support@mh-alliwa.com" class="text-info">
                                                support@mh-alliwa.com
                                            </a>
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="text-muted">Documentation:</span>
                                        <span class="float-end">
                                            <a href="https://docs.mh-alliwa.com" class="text-info" target="_blank">
                                                View Docs
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h4 class="mt-4 mb-3">Features</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush bg-transparent">
                                    <li class="list-group-item bg-transparent text-light">
                                        <i class="fas fa-check text-success me-2"></i>Dual Source Switching
                                    </li>
                                    <li class="list-group-item bg-transparent text-light">
                                        <i class="fas fa-check text-success me-2"></i>Real-time Monitoring
                                    </li>
                                    <li class="list-group-item bg-transparent text-light">
                                        <i class="fas fa-check text-success me-2"></i>Advanced Optimization
                                    </li>
                                    <li class="list-group-item bg-transparent text-light">
                                        <i class="fas fa-check text-success me-2"></i>Web & Mobile Interface
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush bg-transparent">
                                    <li class="list-group-item bg-transparent text-light">
                                        <i class="fas fa-check text-success me-2"></i>Telegram Integration
                                    </li>
                                    <li class="list-group-item bg-transparent text-light">
                                        <i class="fas fa-check text-success me-2"></i>Data Analytics
                                    </li>
                                    <li class="list-group-item bg-transparent text-light">
                                        <i class="fas fa-check text-success me-2"></i>Cloud Synchronization
                                    </li>
                                    <li class="list-group-item bg-transparent text-light">
                                        <i class="fas fa-check text-success me-2"></i>OTA Updates
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <i class="fas fa-info-circle me-2"></i>
                            This system is developed and maintained by <strong>mh_alliwa</strong>.
                            For support, contact via Telegram <strong>@mh_alliwa</strong> or Instagram <strong>@mh.alliwa</strong>.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="alertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalTitle">Alert</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    Alert message here...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Are you sure?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmModalButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let charts = {};
        let currentSection = 'dashboard';
        let logPage = 1;
        let logPageSize = 50;
        
        // Initialize
        function init() {
            updateTime();
            setInterval(updateTime, 1000);
            fetchData();
            setInterval(fetchData, 2000);
            initCharts();
            loadSystemInfo();
            
            // Initialize modals
            const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('id-ID', {hour12: false});
        }
        
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('[id$="-section"]').forEach(el => {
                el.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(section + '-section').style.display = 'block';
            
            // Add active class to clicked nav link
            event.target.classList.add('active');
            
            currentSection = section;
            
            // Refresh data for the section
            if (section === 'logs') {
                loadLogs();
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function showAlert(title, message) {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalBody').textContent = message;
            new bootstrap.Modal(document.getElementById('alertModal')).show();
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirmModalBody').textContent = message;
            const btn = document.getElementById('confirmModalButton');
            btn.onclick = () => {
                callback();
                new bootstrap.Modal(document.getElementById('confirmModal')).hide();
            };
            new bootstrap.Modal(document.getElementById('confirmModal')).show();
        }
        
        async function fetchData() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update dashboard
                document.getElementById('total-power').textContent = data.power.toFixed(1) + ' W';
                document.getElementById('total-energy').textContent = data.totalEnergy.toFixed(3) + ' kWh';
                document.getElementById('system-uptime').textContent = formatUptime(data.uptime);
                document.getElementById('system-status').textContent = data.systemState;
                document.getElementById('system-status').className = 
                    data.systemState.includes('ACTIVE') ? 'badge bg-success' :
                    data.systemState.includes('OFF') ? 'badge bg-danger' :
                    data.systemState.includes('SWITCH') ? 'badge bg-warning' : 'badge bg-info';
                
                // Update voltage values
                document.getElementById('voltage1').textContent = data.voltage1.toFixed(1) + ' V';
                document.getElementById('voltage2').textContent = data.voltage2.toFixed(1) + ' V';
                
                // Update control panel info
                document.getElementById('current-source').textContent = 
                    data.systemState.includes('1') ? 'Source 1' : 
                    data.systemState.includes('2') ? 'Source 2' : 'None';
                document.getElementById('auto-mode-status').textContent = 
                    data.autoMode ? 'Enabled' : 'Disabled';
                document.getElementById('maintenance-mode-status').textContent = 
                    data.maintenanceMode ? 'Enabled' : 'Disabled';
                document.getElementById('total-switches').textContent = data.switchCount;
                document.getElementById('wifi-signal').textContent = data.wifiRSSI + ' dBm';
                
                // Update charts
                updateCharts(data);
                
                // Update connection status
                document.getElementById('connection-status').className = 
                    'badge ' + (navigator.onLine ? 'bg-success' : 'bg-danger');
                document.getElementById('connection-status').textContent = 
                    navigator.onLine ? 'Connected' : 'Disconnected';
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('connection-status').className = 'badge bg-danger';
                document.getElementById('connection-status').textContent = 'Error';
            }
        }
        
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (days > 0) return `${days}d ${hours}h ${minutes}m`;
            if (hours > 0) return `${hours}h ${minutes}m ${secs}s`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        }
        
        function initCharts() {
            // Main chart
            const mainCtx = document.getElementById('mainChart').getContext('2d');
            charts.main = new Chart(mainCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Source 1 Voltage',
                            data: [],
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Source 2 Voltage',
                            data: [],
                            borderColor: '#4cc9f0',
                            backgroundColor: 'rgba(76, 201, 240, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Voltage (V)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#f8f9fa'
                            }
                        }
                    }
                }
            });
            
            // Monitoring chart
            const monitoringCtx = document.getElementById('monitoringChart').getContext('2d');
            charts.monitoring = new Chart(monitoringCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Current',
                            data: [],
                            borderColor: '#f72585',
                            backgroundColor: 'rgba(247, 37, 133, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Power',
                            data: [],
                            borderColor: '#f8961e',
                            backgroundColor: 'rgba(248, 150, 30, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Current (A)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Power (W)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // Initialize other charts
            initGaugeChart();
            initEnergyChart();
        }
        
        function initGaugeChart() {
            const gaugeCtx = document.getElementById('gaugeChart').getContext('2d');
            charts.gauge = new Chart(gaugeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Used', 'Remaining'],
                    datasets: [{
                        data: [30, 70],
                        backgroundColor: ['#f72585', '#4cc9f0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                },
                plugins: [{
                    id: 'gaugeText',
                    afterDraw: (chart) => {
                        const {ctx, chartArea: {width, height}} = chart;
                        ctx.save();
                        ctx.font = 'bold 30px sans-serif';
                        ctx.fillStyle = '#f8f9fa';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('70%', width / 2, height / 2);
                        ctx.restore();
                    }
                }]
            });
        }
        
        function initEnergyChart() {
            const energyCtx = document.getElementById('energyChart').getContext('2d');
            charts.energy = new Chart(energyCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Energy Consumption (kWh)',
                        data: [12, 19, 15, 25, 22, 30, 28],
                        backgroundColor: '#4361ee',
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'kWh'
                            }
                        }
                    }
                }
            });
        }
        
        function updateCharts(data) {
            const now = new Date();
            
            // Update main chart
            if (charts.main) {
                if (charts.main.data.labels.length > 60) {
                    charts.main.data.labels.shift();
                    charts.main.data.datasets[0].data.shift();
                    charts.main.data.datasets[1].data.shift();
                }
                charts.main.data.labels.push(now);
                charts.main.data.datasets[0].data.push(data.voltage1);
                charts.main.data.datasets[1].data.push(data.voltage2);
                charts.main.update('none');
            }
            
            // Update monitoring chart
            if (charts.monitoring) {
                if (charts.monitoring.data.labels.length > 60) {
                    charts.monitoring.data.labels.shift();
                    charts.monitoring.data.datasets[0].data.shift();
                    charts.monitoring.data.datasets[1].data.shift();
                }
                charts.monitoring.data.labels.push(now);
                charts.monitoring.data.datasets[0].data.push(data.current);
                charts.monitoring.data.datasets[1].data.push(data.power);
                charts.monitoring.update('none');
            }
        }
        
        async function controlSource(source) {
            showConfirm('Are you sure you want to switch power source?', async () => {
                try {
                    const response = await fetch('/api/control', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: source === 0 ? 'off' : 
                                   source === 1 ? 'source1' : 'source2'
                        })
                    });
                    const result = await response.json();
                    showAlert('Success', result.message);
                    fetchData();
                } catch (error) {
                    showAlert('Error', 'Control failed');
                }
            });
        }
        
        async function toggleMode() {
            try {
                const response = await fetch('/api/mode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ mode: 'toggle' })
                });
                const result = await response.json();
                showAlert('Success', 'Mode changed to ' + (result.autoMode ? 'AUTO' : 'MANUAL'));
                fetchData();
            } catch (error) {
                showAlert('Error', 'Mode change failed');
            }
        }
        
        async function calibrateSource(source) {
            const value = document.getElementById('cal-v' + source).value;
            showConfirm('Calibrate Source ' + source + ' with factor ' + value + '?', async () => {
                try {
                    const response = await fetch('/api/calibrate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            source: source,
                            factor: parseFloat(value)
                        })
                    });
                    const result = await response.json();
                    showAlert('Success', result.message);
                } catch (error) {
                    showAlert('Error', 'Calibration failed');
                }
            });
        }
        
        async function calibrateCurrent() {
            const value = document.getElementById('cal-current').value;
            showConfirm('Calibrate current sensor with factor ' + value + '?', async () => {
                try {
                    const response = await fetch('/api/calibrate/current', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ factor: parseFloat(value) })
                    });
                    const result = await response.json();
                    showAlert('Success', result.message);
                } catch (error) {
                    showAlert('Error', 'Calibration failed');
                }
            });
        }
        
        async function autoOptimization() {
            showConfirm('Run automatic system optimization? This may take a few minutes.', async () => {
                try {
                    const response = await fetch('/api/optimize', {method: 'POST'});
                    const result = await response.json();
                    showAlert('Success', result.message);
                    document.getElementById('optimization-results').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Optimization completed successfully!<br>
                            V1 Factor: ${result.factors.v1.toFixed(4)}<br>
                            V2 Factor: ${result.factors.v2.toFixed(4)}<br>
                            I Factor: ${result.factors.i.toFixed(4)}<br>
                            Accuracy: ${result.accuracy.toFixed(2)}%
                        </div>
                    `;
                } catch (error) {
                    showAlert('Error', 'Optimization failed');
                }
            });
        }
        
        async function resetCalibration() {
            showConfirm('Reset all calibration to factory defaults?', async () => {
                try {
                    const response = await fetch('/api/calibrate/reset', {method: 'POST'});
                    const result = await response.json();
                    showAlert('Success', result.message);
                    document.getElementById('cal-v1').value = '1.000';
                    document.getElementById('cal-v2').value = '1.000';
                    document.getElementById('cal-current').value = '1.000';
                } catch (error) {
                    showAlert('Error', 'Reset failed');
                }
            });
        }
        
        async function saveConfiguration() {
            const mode = document.getElementById('operation-mode').value;
            const threshold = document.getElementById('switch-threshold').value;
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        mode: mode,
                        threshold: parseFloat(threshold)
                    })
                });
                const result = await response.json();
                showAlert('Success', result.message);
            } catch (error) {
                showAlert('Error', 'Save failed');
            }
        }
        
        async function saveNetworkSettings() {
            const ssid = document.getElementById('wifi-ssid').value;
            const password = document.getElementById('wifi-password').value;
            const hostname = document.getElementById('hostname').value;
            const port = document.getElementById('web-port').value;
            
            try {
                const response = await fetch('/api/network', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ssid: ssid,
                        password: password,
                        hostname: hostname,
                        port: parseInt(port)
                    })
                });
                const result = await response.json();
                showAlert('Success', result.message);
                if (result.restart) {
                    showAlert('Info', 'System will restart to apply settings');
                }
            } catch (error) {
                showAlert('Error', 'Save failed');
            }
        }
        
        async function saveNotificationSettings() {
            const telegram = document.getElementById('notif-telegram').checked;
            const vlow = document.getElementById('alert-vlow').value;
            const vhigh = document.getElementById('alert-vhigh').value;
            const ihigh = document.getElementById('alert-ihigh').value;
            
            try {
                const response = await fetch('/api/notifications', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram: telegram,
                        voltage_low: parseFloat(vlow),
                        voltage_high: parseFloat(vhigh),
                        current_high: parseFloat(ihigh)
                    })
                });
                const result = await response.json();
                showAlert('Success', result.message);
            } catch (error) {
                showAlert('Error', 'Save failed');
            }
        }
        
        async function backupSystem() {
            showConfirm('Create system backup?', async () => {
                try {
                    const response = await fetch('/api/backup');
                    const data = await response.json();
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `power_system_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('Success', 'Backup downloaded successfully');
                } catch (error) {
                    showAlert('Error', 'Backup failed');
                }
            });
        }
        
        async function restartSystem() {
            showConfirm('Restart system?', async () => {
                try {
                    await fetch('/api/restart', {method: 'POST'});
                    showAlert('Info', 'System restarting... Please wait 30 seconds.');
                } catch (error) {
                    showAlert('Info', 'Restart command sent');
                }
            });
        }
        
        async function factoryReset() {
            showConfirm('‚ö†Ô∏è FACTORY RESET ‚ö†Ô∏è\n\nThis will erase all settings and calibration data. Continue?', async () => {
                try {
                    const response = await fetch('/api/factory-reset', {method: 'POST'});
                    const result = await response.json();
                    showAlert('Success', result.message);
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } catch (error) {
                    showAlert('Error', 'Factory reset failed');
                }
            });
        }
        
        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/system/info');
                const data = await response.json();
                
                document.getElementById('chip-id').textContent = data.chipId;
                document.getElementById('flash-size').textContent = (data.flashSize / 1024 / 1024).toFixed(1) + ' MB';
                document.getElementById('free-heap').textContent = (data.freeHeap / 1024).toFixed(1) + ' KB';
                document.getElementById('last-update').textContent = new Date(data.lastUpdate * 1000).toLocaleString();
                
            } catch (error) {
                console.error('Error loading system info:', error);
            }
        }
        
        async function loadLogs() {
            try {
                const level = document.getElementById('log-level').value;
                const period = document.getElementById('log-period').value;
                
                const response = await fetch(`/api/logs?level=${level}&period=${period}&page=${logPage}&size=${logPageSize}`);
                const data = await response.json();
                
                const tbody = document.getElementById('log-table');
                tbody.innerHTML = '';
                
                if (data.logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">No logs found</td></tr>';
                    return;
                }
                
                data.logs.forEach(log => {
                    const row = document.createElement('tr');
                    
                    let levelClass = 'badge ';
                    switch (log.level) {
                        case 'ERROR': levelClass += 'bg-danger'; break;
                        case 'WARNING': levelClass += 'bg-warning'; break;
                        case 'INFO': levelClass += 'bg-info'; break;
                        default: levelClass += 'bg-secondary';
                    }
                    
                    row.innerHTML = `
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td><span class="${levelClass}">${log.level}</span></td>
                        <td>${log.source}</td>
                        <td>${log.message}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('log-page-info').textContent = 
                    `Page ${data.page} of ${data.totalPages}`;
                
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }
        
        function loadMoreLogs(direction) {
            if (direction === 'next') {
                logPage++;
            } else if (direction === 'prev' && logPage > 1) {
                logPage--;
            }
            loadLogs();
        }
        
        function searchLogs() {
            const query = document.getElementById('log-search').value;
            if (query.trim()) {
                // Implement search logic here
                showAlert('Info', 'Search functionality coming soon');
            } else {
                loadLogs();
            }
        }
        
        async function exportLogs() {
            try {
                const response = await fetch('/api/logs/export');
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `system_logs_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showAlert('Success', 'Logs exported successfully');
            } catch (error) {
                showAlert('Error', 'Export failed');
            }
        }
        
        async function clearLogs() {
            showConfirm('Clear all system logs?', async () => {
                try {
                    await fetch('/api/logs/clear', {method: 'POST'});
                    showAlert('Success', 'Logs cleared');
                    loadLogs();
                } catch (error) {
                    showAlert('Error', 'Clear failed');
                }
            });
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
)rawliteral";

// ========== FUNGSI SENSOR ==========
float readTrueRMS(uint8_t pin, int zeroPoint) {
  const int samples = 2000;
  unsigned long sumSquares = 0;
  
  for (int i = 0; i < samples; i++) {
    int raw = analogRead(pin);
    int offset = raw - zeroPoint;
    sumSquares += (unsigned long)offset * offset;
    delayMicroseconds(40);
  }
  
  return sqrt((float)sumSquares / samples);
}

float convertToVoltage(float rmsADC, float calibFactor, float offset = 0) {
  float voltageADC = rmsADC * 3.3 / 4095;
  float realVoltage = (voltageADC * calibFactor * 250.0) / (1.8 * 0.7071) + offset;
  return realVoltage;
}

void readSensors() {
  static unsigned long lastRead = 0;
  if (millis() - lastRead < 500) return;
  lastRead = millis();
  
  // Read RMS values
  float rmsV1 = readTrueRMS(PIN_ZMPT1, optim.zeroV1);
  float rmsV2 = readTrueRMS(PIN_ZMPT2, optim.zeroV2);
  float rmsI = readTrueRMS(PIN_ACS, optim.zeroI);
  
  // Convert to actual values
  sensors.voltage1 = convertToVoltage(rmsV1, optim.calibrationFactorV1, optim.voltageOffsetV1);
  sensors.voltage2 = convertToVoltage(rmsV2, optim.calibrationFactorV2, optim.voltageOffsetV2);
  
  // Current calculation
  float voltageAdcI = rmsI * 3.3 / 4095;
  sensors.current = (voltageAdcI - (3.3/2)) / 0.100 * optim.calibrationFactorI;
  
  // Store in history
  voltageHistory1[historyIndex] = sensors.voltage1;
  voltageHistory2[historyIndex] = sensors.voltage2;
  currentHistory[historyIndex] = sensors.current;
  historyIndex = (historyIndex + 1) % DATA_BUFFER_SIZE;
  
  // Calculate power
  if (systemState == STATE_SOURCE1_ACTIVE && sensors.voltage1 > 10) {
    sensors.power = sensors.voltage1 * abs(sensors.current);
  } else if (systemState == STATE_SOURCE2_ACTIVE && sensors.voltage2 > 10) {
    sensors.power = sensors.voltage2 * abs(sensors.current);
  } else {
    sensors.power = 0;
  }
  
  // Update energy
  if (sensors.power > 0 && lastEnergyUpdate > 0) {
    float hours = (millis() - lastEnergyUpdate) / 3600000.0;
    float energyAdd = sensors.power * hours / 1000.0;
    totalEnergy += energyAdd;
    dailyEnergy += energyAdd;
    monthlyEnergy += energyAdd;
  }
  lastEnergyUpdate = millis();
  
  // Reset daily energy at midnight
  if (timeClient.getHours() == 0 && timeClient.getMinutes() == 0) {
    if (millis() - lastDailyReset > 60000) { // Check once per minute
      dailyEnergy = 0;
      lastDailyReset = millis();
    }
  }
}

// ========== FUNGSI OPTIMIZATION ==========
void performOptimization() {
  Serial.println("\nüéØ STARTING SYSTEM OPTIMIZATION");
  systemState = STATE_OPTIMIZATION;
  
  // Save current state
  bool oldAutoMode = autoMode;
  autoMode = false;
  
  // Turn off all relays
  digitalWrite(RELAY1_PIN, HIGH);
  digitalWrite(RELAY2_PIN, HIGH);
  delay(2000);
  
  // Optimize zero points
  const int OPTIM_SAMPLES = 5000;
  long sumV1 = 0, sumV2 = 0, sumI = 0;
  
  for (int i = 0; i < OPTIM_SAMPLES; i++) {
    sumV1 += analogRead(PIN_ZMPT1);
    sumV2 += analogRead(PIN_ZMPT2);
    sumI += analogRead(PIN_ACS);
    delayMicroseconds(50);
  }
  
  optim.zeroV1 = sumV1 / OPTIM_SAMPLES;
  optim.zeroV2 = sumV2 / OPTIM_SAMPLES;
  optim.zeroI = sumI / OPTIM_SAMPLES;
  
  // Auto-adjust calibration factors
  float targetVoltage = 220.0;
  float measuredV1 = convertToVoltage(readTrueRMS(PIN_ZMPT1, optim.zeroV1), optim.calibrationFactorV1);
  float measuredV2 = convertToVoltage(readTrueRMS(PIN_ZMPT2, optim.zeroV2), optim.calibrationFactorV2);
  
  if (measuredV1 > 50 && measuredV1 < 300) {
    optim.calibrationFactorV1 *= (targetVoltage / measuredV1);
  }
  if (measuredV2 > 50 && measuredV2 < 300) {
    optim.calibrationFactorV2 *= (targetVoltage / measuredV2);
  }
  
  // Save optimization
  preferences.begin("power-switch", false);
  preferences.putInt("zeroV1", optim.zeroV1);
  preferences.putInt("zeroV2", optim.zeroV2);
  preferences.putInt("zeroI", optim.zeroI);
  preferences.putFloat("calV1", optim.calibrationFactorV1);
  preferences.putFloat("calV2", optim.calibrationFactorV2);
  preferences.putFloat("calI", optim.calibrationFactorI);
  preferences.end();
  
  // Restore mode
  autoMode = oldAutoMode;
  systemState = STATE_OFF;
  
  Serial.println("‚úÖ OPTIMIZATION COMPLETE");
  sendTelegramAlert("‚úÖ *SYSTEM OPTIMIZATION COMPLETE*\nAccuracy improved and saved!");
}

// ========== FUNGSI WEB SERVER ==========
void initWebServer() {
  // Setup mDNS
  if (!MDNS.begin("powerswitch-v3")) {
    Serial.println("‚ùå Error setting up mDNS!");
  }
  
  // Basic web interface
  server.on("/", HTTP_GET, []() {
    String page = String(basicWebPage);
    page.replace("%GITHUB_USERNAME%", githubUsername);
    page.replace("%GITHUB_REPO%", githubRepo);
    server.send(200, "text/html", page);
  });
  
  // Advanced web interface
  server.on("/advanced", HTTP_GET, []() {
    String page = String(advancedWebPage);
    page.replace("%SSID%", ssid);
    page.replace("%PASSWORD%", pass);
    server.send(200, "text/html", page);
  });
  
  // API endpoints
  server.on("/api/status", HTTP_GET, []() {
    StaticJsonDocument<512> doc;
    
    // Sensor data
    doc["voltage1"] = sensors.voltage1;
    doc["voltage2"] = sensors.voltage2;
    doc["current"] = sensors.current;
    doc["power"] = sensors.power;
    doc["totalEnergy"] = totalEnergy;
    doc["dailyEnergy"] = dailyEnergy;
    doc["monthlyEnergy"] = monthlyEnergy;
    
    // System state
    doc["systemState"] = getStateText();
    doc["autoMode"] = autoMode;
    doc["maintenanceMode"] = maintenanceMode;
    doc["uptime"] = millis() / 1000;
    doc["wifiRSSI"] = WiFi.RSSI();
    doc["ipAddress"] = WiFi.localIP().toString();
    doc["switchCount"] = stats.switchCount;
    doc["faultCount"] = stats.faultCount;
    
    // History data
    JsonArray v1Hist = doc.createNestedArray("voltageHistory1");
    JsonArray v2Hist = doc.createNestedArray("voltageHistory2");
    JsonArray iHist = doc.createNestedArray("currentHistory");
    
    for (int i = 0; i < min(50, DATA_BUFFER_SIZE); i++) {
      int idx = (historyIndex - 1 - i + DATA_BUFFER_SIZE) % DATA_BUFFER_SIZE;
      v1Hist.add(voltageHistory1[idx]);
      v2Hist.add(voltageHistory2[idx]);
      iHist.add(currentHistory[idx]);
    }
    
    String jsonResponse;
    serializeJson(doc, jsonResponse);
    server.send(200, "application/json", jsonResponse);
  });
  
  server.on("/api/control", HTTP_POST, []() {
    if (server.hasArg("plain")) {
      StaticJsonDocument<200> doc;
      deserializeJson(doc, server.arg("plain"));
      
      String action = doc["action"];
      bool success = false;
      String message = "";
      
      if (action == "off") {
        digitalWrite(RELAY1_PIN, HIGH);
        digitalWrite(RELAY2_PIN, HIGH);
        systemState = STATE_OFF;
        success = true;
        message = "System turned OFF";
      } 
      else if (action == "source1") {
        if (!maintenanceMode) {
          digitalWrite(RELAY1_PIN, LOW);
          digitalWrite(RELAY2_PIN, HIGH);
          systemState = STATE_SOURCE1_ACTIVE;
          stats.switchCount++;
          success = true;
          message = "Switched to Source 1";
        }
      }
      else if (action == "source2") {
        if (!maintenanceMode) {
          digitalWrite(RELAY1_PIN, HIGH);
          digitalWrite(RELAY2_PIN, LOW);
          systemState = STATE_SOURCE2_ACTIVE;
          stats.switchCount++;
          success = true;
          message = "Switched to Source 2";
        }
      }
      
      StaticJsonDocument<100> response;
      response["success"] = success;
      response["message"] = message;
      
      String jsonResponse;
      serializeJson(response, jsonResponse);
      server.send(200, "application/json", jsonResponse);
      
      if (success) {
        sendTelegramAlert("üéÆ Manual control: " + message);
      }
    }
  });
  
  server.on("/api/mode", HTTP_POST, []() {
    if (server.hasArg("plain")) {
      StaticJsonDocument<200> doc;
      deserializeJson(doc, server.arg("plain"));
      
      String mode = doc["mode"];
      if (mode == "toggle") {
        autoMode = !autoMode;
      } else if (mode == "auto") {
        autoMode = true;
      } else if (mode == "manual") {
        autoMode = false;
      }
      
      preferences.begin("power-switch", false);
      preferences.putBool("autoMode", autoMode);
      preferences.end();
      
      StaticJsonDocument<100> response;
      response["success"] = true;
      response["autoMode"] = autoMode;
      response["message"] = "Mode updated";
      
      String jsonResponse;
      serializeJson(response, jsonResponse);
      server.send(200, "application/json", jsonResponse);
      
      sendTelegramAlert("üîß Mode changed to: " + String(autoMode ? "AUTO" : "MANUAL"));
    }
  });
  
  server.on("/api/optimize", HTTP_POST, []() {
    StaticJsonDocument<100> response;
    response["success"] = true;
    response["message"] = "Optimization started";
    
    String jsonResponse;
    serializeJson(response, jsonResponse);
    server.send(200, "application/json", jsonResponse);
    
    performOptimization();
  });
  
  server.on("/api/logs", HTTP_GET, []() {
    StaticJsonDocument<1024> doc;
    JsonArray logs = doc.createNestedArray("logs");
    
    // Add sample logs
    JsonObject log1 = logs.createNestedObject();
    log1["timestamp"] = timeClient.getEpochTime() - 3600;
    log1["level"] = "INFO";
    log1["source"] = "System";
    log1["message"] = "System boot completed";
    
    JsonObject log2 = logs.createNestedObject();
    log2["timestamp"] = timeClient.getEpochTime() - 1800;
    log2["level"] = "WARNING";
    log2["source"] = "Voltage Sensor";
    log2["message"] = "Source 1 voltage low: 175V";
    
    doc["page"] = 1;
    doc["totalPages"] = 1;
    
    String jsonResponse;
    serializeJson(doc, jsonResponse);
    server.send(200, "application/json", jsonResponse);
  });
  
  server.on("/api/system/info", HTTP_GET, []() {
    StaticJsonDocument<256> doc;
    
    doc["chipId"] = ESP.getEfuseMac();
    doc["flashSize"] = ESP.getFlashChipSize();
    doc["freeHeap"] = ESP.getFreeHeap();
    doc["sketchSize"] = ESP.getSketchSize();
    doc["freeSketchSpace"] = ESP.getFreeSketchSpace();
    doc["lastUpdate"] = preferences.getULong("lastUpdate", 0);
    doc["firmwareVersion"] = "3.0.0";
    doc["developer"] = "mh_alliwa";
    
    String jsonResponse;
    serializeJson(doc, jsonResponse);
    server.send(200, "application/json", jsonResponse);
  });
  
  server.on("/api/backup", HTTP_GET, []() {
    StaticJsonDocument<1024> doc;
    
    // System data
    doc["totalEnergy"] = totalEnergy;
    doc["dailyEnergy"] = dailyEnergy;
    doc["monthlyEnergy"] = monthlyEnergy;
    doc["switchCount"] = stats.switchCount;
    doc["faultCount"] = stats.faultCount;
    
    // Optimization data
    doc["zeroV1"] = optim.zeroV1;
    doc["zeroV2"] = optim.zeroV2;
    doc["zeroI"] = optim.zeroI;
    doc["calV1"] = optim.calibrationFactorV1;
    doc["calV2"] = optim.calibrationFactorV2;
    doc["calI"] = optim.calibrationFactorI;
    
    // Settings
    doc["autoMode"] = autoMode;
    doc["maintenanceMode"] = maintenanceMode;
    doc["notificationEnabled"] = notificationEnabled;
    
    // Timestamp
    doc["backupTime"] = timeClient.getEpochTime();
    doc["backupVersion"] = "3.0";
    
    String jsonResponse;
    serializeJson(doc, jsonResponse);
    server.send(200, "application/json", jsonResponse);
  });
  
  server.on("/api/restart", HTTP_POST, []() {
    StaticJsonDocument<100> response;
    response["success"] = true;
    response["message"] = "System restarting...";
    
    String jsonResponse;
    serializeJson(response, jsonResponse);
    server.send(200, "application/json", jsonResponse);
    
    delay(1000);
    ESP.restart();
  });
  
  server.onNotFound([]() {
    server.send(404, "text/plain", "Not Found");
  });
  
  server.begin();
  Serial.println("‚úÖ Web server started!");
  Serial.println("üì± Basic Interface: http://" + WiFi.localIP().toString());
  Serial.println("üìä Advanced Interface: http://" + WiFi.localIP().toString() + "/advanced");
}

// ========== FUNGSI TELEGRAM ==========
void sendTelegramAlert(String message) {
  if (notificationEnabled) {
    bot.sendMessage(CHAT_ID, message, "Markdown");
  }
}

String getStateText() {
  switch (systemState) {
    case STATE_OFF: return "OFF";
    case STATE_SOURCE1_ACTIVE: return "SOURCE 1 ACTIVE";
    case STATE_SOURCE2_ACTIVE: return "SOURCE 2 ACTIVE";
    case STATE_SWITCHING: return "SWITCHING";
    case STATE_FAULT: return "FAULT";
    case STATE_OPTIMIZATION: return "OPTIMIZATION";
    case STATE_UPDATE: return "UPDATING";
    default: return "UNKNOWN";
  }
}

// ========== SETUP ==========
void setup() {
  Serial.begin(115200);
  Serial.println("\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  Serial.println("   POWER SWITCH SYSTEM V3");
  Serial.println("   Developer: mh_alliwa");
  Serial.println("   Telegram: @mh_alliwa");
  Serial.println("   Instagram: @mh.alliwa");
  Serial.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  
  // Hardware setup
  analogReadResolution(12);
  analogSetAttenuation(ADC_11db);
  
  pinMode(RELAY1_PIN, OUTPUT);
  pinMode(RELAY2_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(LED_STATUS, OUTPUT);
  pinMode(BUTTON_MANUAL, INPUT_PULLUP);
  
  digitalWrite(RELAY1_PIN, HIGH);
  digitalWrite(RELAY2_PIN, HIGH);
  digitalWrite(BUZZER_PIN, LOW);
  digitalWrite(LED_STATUS, LOW);
  
  // LCD setup
  Wire.begin(21, 22);
  lcd.init();
  lcd.backlight();
  lcd.clear();
  lcd.print("POWER SWITCH V3");
  lcd.setCursor(0, 1);
  lcd.print("Starting...");
  
  // Load settings
  preferences.begin("power-switch", true);
  optim.zeroV1 = preferences.getInt("zeroV1", 2048);
  optim.zeroV2 = preferences.getInt("zeroV2", 2048);
  optim.zeroI = preferences.getInt("zeroI", 2048);
  optim.calibrationFactorV1 = preferences.getFloat("calV1", 1.0);
  optim.calibrationFactorV2 = preferences.getFloat("calV2", 1.0);
  optim.calibrationFactorI = preferences.getFloat("calI", 1.0);
  autoMode = preferences.getBool("autoMode", true);
  maintenanceMode = preferences.getBool("maintenanceMode", false);
  totalEnergy = preferences.getFloat("totalEnergy", 0);
  dailyEnergy = preferences.getFloat("dailyEnergy", 0);
  monthlyEnergy = preferences.getFloat("monthlyEnergy", 0);
  stats.switchCount = preferences.getUInt("switchCount", 0);
  stats.faultCount = preferences.getUInt("faultCount", 0);
  stats.totalUptime = preferences.getUInt("totalUptime", 0);
  preferences.end();
  
  // WiFi connection
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, pass);
  
  lcd.setCursor(0, 1);
  lcd.print("Connecting WiFi");
  
  int timeout = 0;
  while (WiFi.status() != WL_CONNECTED && timeout < 30) {
    delay(500);
    Serial.print(".");
    lcd.setCursor(timeout % 16, 0);
    lcd.print(".");
    timeout++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n‚úÖ WiFi Connected!");
    Serial.println("üì° IP: " + WiFi.localIP().toString());
    
    lcd.clear();
    lcd.print("WiFi Connected!");
    lcd.setCursor(0, 1);
    lcd.print(WiFi.localIP().toString());
    
    // Initialize services
    client.setInsecure();
    Blynk.config(BLYNK_AUTH_TOKEN);
    timeClient.begin();
    timeClient.update();
    
    // Web server
    initWebServer();
    
    // Send startup message
    String startupMsg = "üöÄ *POWER SWITCH V3 ONLINE*\n";
    startupMsg += "IP: " + WiFi.localIP().toString() + "\n";
    startupMsg += "Mode: " + String(autoMode ? "AUTO" : "MANUAL") + "\n";
    startupMsg += "Status: " + getStateText() + "\n";
    startupMsg += "Energy: " + String(totalEnergy, 3) + " kWh\n";
    startupMsg += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
    startupMsg += "Developer: mh_alliwa (@mh_alliwa)\n";
    
    bot.sendMessage(CHAT_ID, startupMsg, "Markdown");
    
    delay(2000);
    
  } else {
    Serial.println("\n‚ùå WiFi Connection Failed!");
    lcd.clear();
    lcd.print("WiFi FAILED!");
    lcd.setCursor(0, 1);
    lcd.print("Offline Mode");
  }
  
  // Setup timers
  timer.setInterval(500L, []() {
    Blynk.virtualWrite(V0, sensors.voltage1);
    Blynk.virtualWrite(V1, sensors.voltage2);
    Blynk.virtualWrite(V2, sensors.current);
    Blynk.virtualWrite(V3, sensors.power);
    Blynk.virtualWrite(V4, totalEnergy);
    Blynk.virtualWrite(V5, WiFi.RSSI());
  });
  
  timer.setInterval(1000L, []() {
    static bool ledState = false;
    digitalWrite(LED_STATUS, ledState);
    ledState = !ledState;
    
    // Update LCD
    lcd.clear();
    if (systemState == STATE_OFF) {
      lcd.print("SYSTEM OFF");
    } else if (systemState == STATE_SOURCE1_ACTIVE) {
      lcd.print("SOURCE 1 ACTIVE");
    } else if (systemState == STATE_SOURCE2_ACTIVE) {
      lcd.print("SOURCE 2 ACTIVE");
    }
    lcd.setCursor(0, 1);
    lcd.printf("V1:%.0f V2:%.0f", sensors.voltage1, sensors.voltage2);
  });
  
  lcd.clear();
  lcd.print("SYSTEM READY");
  lcd.setCursor(0, 1);
  lcd.print("V3.0 - mh_alliwa");
  delay(2000);
}

// ========== LOOP ==========
void loop() {
  Blynk.run();
  timer.run();
  server.handleClient();
  
  readSensors();
  timeClient.update();
  
  // Auto mode logic
  if (autoMode && !maintenanceMode) {
    if (systemState == STATE_SOURCE1_ACTIVE && sensors.voltage1 < 180 && sensors.voltage2 >= 180) {
      Serial.println("‚ö†Ô∏è Auto-switch to Source 2");
      digitalWrite(RELAY1_PIN, HIGH);
      digitalWrite(RELAY2_PIN, LOW);
      systemState = STATE_SOURCE2_ACTIVE;
      stats.switchCount++;
      sendTelegramAlert("üîÅ *AUTO SWITCH*\nSource 1 voltage low (" + String(sensors.voltage1, 1) + 
                       "V)\nSwitched to Source 2");
    }
    else if (systemState == STATE_SOURCE2_ACTIVE && sensors.voltage1 >= 190) {
      Serial.println("üîÅ Auto-switch to Source 1");
      digitalWrite(RELAY1_PIN, LOW);
      digitalWrite(RELAY2_PIN, HIGH);
      systemState = STATE_SOURCE1_ACTIVE;
      stats.switchCount++;
      sendTelegramAlert("üîÅ *AUTO SWITCH*\nSource 1 restored (" + String(sensors.voltage1, 1) + 
                       "V)\nSwitched back to Source 1");
    }
    else if (systemState == STATE_OFF && sensors.voltage1 >= 180) {
      Serial.println("üîÅ Auto-start Source 1");
      digitalWrite(RELAY1_PIN, LOW);
      digitalWrite(RELAY2_PIN, HIGH);
      systemState = STATE_SOURCE1_ACTIVE;
      stats.switchCount++;
      sendTelegramAlert("üîÅ *AUTO START*\nVoltage detected: " + String(sensors.voltage1, 1) + 
                       "V\nSystem started automatically");
    }
  }
  
  // Safety checks
  if (sensors.voltage1 > 250 || sensors.voltage2 > 250) {
    emergencyShutdown("Over-voltage detected!");
  }
  if (abs(sensors.current) > 25) {
    emergencyShutdown("Over-current detected!");
  }
  
  // Manual button
  static unsigned long lastButtonPress = 0;
  if (!digitalRead(BUTTON_MANUAL) && millis() - lastButtonPress > 1000) {
    lastButtonPress = millis();
    if (systemState == STATE_OFF && sensors.voltage1 > 100) {
      digitalWrite(RELAY1_PIN, LOW);
      systemState = STATE_SOURCE1_ACTIVE;
      sendTelegramAlert("üîò *MANUAL BUTTON*\nSystem started via button");
    } else {
      digitalWrite(RELAY1_PIN, HIGH);
      digitalWrite(RELAY2_PIN, HIGH);
      systemState = STATE_OFF;
      sendTelegramAlert("üîò *MANUAL BUTTON*\nSystem stopped via button");
    }
  }
  
  // Periodic save
  static unsigned long lastSave = 0;
  if (millis() - lastSave > 300000) { // 5 minutes
    lastSave = millis();
    preferences.begin("power-switch", false);
    preferences.putFloat("totalEnergy", totalEnergy);
    preferences.putFloat("dailyEnergy", dailyEnergy);
    preferences.putFloat("monthlyEnergy", monthlyEnergy);
    preferences.putUInt("switchCount", stats.switchCount);
    preferences.putUInt("faultCount", stats.faultCount);
    preferences.putUInt("totalUptime", stats.totalUptime + (millis() / 1000));
    preferences.end();
    Serial.println("üíæ Settings saved");
  }
}

void emergencyShutdown(String reason) {
  Serial.println("üö® EMERGENCY: " + reason);
  
  digitalWrite(RELAY1_PIN, HIGH);
  digitalWrite(RELAY2_PIN, HIGH);
  digitalWrite(BUZZER_PIN, HIGH);
  systemState = STATE_FAULT;
  stats.faultCount++;
  
  String message = "üö® *EMERGENCY SHUTDOWN!*\n";
  message += "Reason: " + reason + "\n";
  message += "V1: " + String(sensors.voltage1, 1) + "V\n";
  message += "V2: " + String(sensors.voltage2, 1) + "V\n";
  message += "I: " + String(sensors.current, 2) + "A\n";
  message += "All relays turned OFF\n";
  message += "System requires manual reset";
  
  sendTelegramAlert(message);
  
  // Alert pattern
  for (int i = 0; i < 10; i++) {
    digitalWrite(LED_STATUS, !digitalRead(LED_STATUS));
    digitalWrite(BUZZER_PIN, !digitalRead(BUZZER_PIN));
    delay(200);
  }
  
  digitalWrite(BUZZER_PIN, LOW);
}
